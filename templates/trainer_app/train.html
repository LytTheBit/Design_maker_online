<!-- templates/trainer_app/train.html -->
{% extends 'base.html' %}
{% load i18n widget_tweaks %}

{% block title %}{% trans "Addestramento LoRA" %}{% endblock %}

{% block content %}
<div class="container-xl my-5">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">{% trans "Addestramento nuovo modello LoRA" %}</h2>
  </div>

  {# errori non-campo (es: "carica zip o immagini") #}
  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">{{ form.name.label }}</label>
            {% render_field form.name class="form-control" placeholder="nome-modello" %}
            {% if form.name.errors %}<div class="text-danger small">{{ form.name.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-md-4">
            <label class="form-label">{% trans "Base model" %}</label>
            {% render_field form.base_model class="form-select" %}
            {% if form.base_model.errors %}<div class="text-danger small">{{ form.base_model.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ form.steps.label }}</label>
            {% render_field form.steps class="form-control" %}
            {% if form.steps.errors %}<div class="text-danger small">{{ form.steps.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-md-1">
            <label class="form-label">{{ form.rank.label }}</label>
            {% render_field form.rank class="form-control" %}
            {% if form.rank.errors %}<div class="text-danger small">{{ form.rank.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-md-1">
            <label class="form-label">{{ form.lr.label }}</label>
            {% render_field form.lr class="form-control" %}
            {% if form.lr.errors %}<div class="text-danger small">{{ form.lr.errors|join:", " }}</div>{% endif %}
          </div>
        </div>

        <hr class="my-4">

        <div class="row g-4">
          <div class="col-lg-6">
            <div class="border rounded-3 p-3 h-100">
              <div class="mb-2 fw-semibold">{% trans "Opzione A: carica ZIP del dataset" %}</div>
              {% render_field form.zip_dataset class="form-control" %}
              {% if form.zip_dataset.errors %}<div class="text-danger small mt-1">{{ form.zip_dataset.errors|join:", " }}</div>{% endif %}
              <small class="text-muted d-block mt-2">
                {% trans "ZIP con immagini e (opzionale) captions.txt." %}
              </small>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="border rounded-3 p-3 h-100">
              <div class="mb-2 fw-semibold">{% trans "Opzione B: immagini singole" %}</div>
              <div class="mb-2">
                <label class="form-label">{{ form.images.label|default:"Immagini" }}</label>
                {% render_field form.images class="form-control" %}
                {% if form.images.errors %}<div class="text-danger small mt-1">{{ form.images.errors|join:", " }}</div>{% endif %}
                <small class="text-muted d-block">{% trans "Puoi selezionare più file." %}</small>
              </div>
              <div>
                <label class="form-label">{{ form.captions.label|default:"Captions" }}</label>
                {% render_field form.captions class="form-control" %}
                {% if form.captions.errors %}<div class="text-danger small mt-1">{{ form.captions.errors|join:", " }}</div>{% endif %}
                <small class="text-muted d-block">
                  {% trans "Formato" %} <code>captions.txt</code>:
                  {% trans "una riga per file" %} <code>filename.jpg|caption</code>.
                </small>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="card-footer bg-transparent">
        <button id="submitBtn" type="submit" class="btn btn-primary">
          <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner" role="status" aria-hidden="true"></span>
          {% trans "Avvia addestramento" %}
        </button>
      </div>
    </div>
  </form>

  {% if job_id %}
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <span class="fw-semibold">{% trans "Stato job" %}:</span>
        <code id="jid">{{ job_id }}</code>
      </div>
      <small class="text-muted" id="statusLabel">running…</small>
    </div>
    <div class="card-body">
      <div class="progress mb-3" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div id="bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 1%">1%</div>
      </div>

      <pre class="logbox mb-0" id="log">In attesa di output…</pre>

      <div class="alert alert-success mt-3 d-none" id="done">
        {% trans "Modello" %} <b id="lname"></b> {% trans "pronto! Lo trovi nel menù del generatore." %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<style>
  .logbox{
    height: 320px;
    background: #0f172a;
    color: #e2e8f0;
    border-radius: .5rem;
    padding: 12px;
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: .9rem;
  }
</style>

{% if job_id %}
<script>
  const submitBtn = document.getElementById('submitBtn');
  const spinner = document.getElementById('spinner');
  if (submitBtn) {
    submitBtn.addEventListener('click', () => {
      if (spinner) spinner.classList.remove('d-none');
      submitBtn.setAttribute('disabled', 'disabled');
    });
  }

  const job = "{{ job_id }}";
  function autoscroll(el){ el.scrollTop = el.scrollHeight; }
  async function poll(){
    const url = "{% url 'trainer_app:status' job_id='00000000-0000-0000-0000-000000000000' %}".replace("00000000-0000-0000-0000-000000000000", job);
    try{
      const r = await fetch(url);
      if(!r.ok){ setTimeout(poll, 2000); return; }
      const d = await r.json();
      const bar = document.getElementById("bar");
      bar.style.width = d.progress + "%";
      bar.textContent = d.progress + "%";
      document.getElementById("log").textContent = d.log || "";
      autoscroll(document.getElementById("log"));
      document.getElementById("statusLabel").textContent = d.status;

      if(d.status === "completed"){
        document.getElementById("lname").textContent = d.lora_name;
        document.getElementById("done").classList.remove("d-none");
        bar.classList.remove("progress-bar-animated");
      } else if(d.status === "failed"){
        bar.classList.add("bg-danger");
        bar.classList.remove("progress-bar-animated");
      } else {
        setTimeout(poll, 2000);
      }
    }catch(e){ setTimeout(poll, 3000); }
  }
  poll();
</script>
{% endif %}
{% endblock %}

{% if job_id %}
<hr>

<style>
  .tm-card { max-width: 900px; margin: 1rem auto; padding: 1rem 1.25rem; border: 1px solid #ddd; border-radius: 12px; background: #fff; }
  .tm-row { display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .tm-progress-outer { width:100%; height:16px; background:#eee; border-radius:999px; overflow:hidden; }
  .tm-progress-inner { height:100%; width:0%; background:#3b82f6; transition: width .35s ease; }
  .tm-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; white-space: pre-wrap; }
  .tm-log { max-height: 260px; overflow: auto; background:#0f172a; color:#e2e8f0; padding:.75rem; border-radius:8px; }
  .tm-muted { color:#666; }
  .tm-btn { display:inline-block; padding:.6rem 1rem; border-radius:10px; text-decoration:none; background:#0ea5e9; color:#fff; border:none; }
  .tm-btn.secondary { background:#64748b; }
  .tm-hidden { display:none; }
</style>

<div class="tm-card" id="job-card" data-job="{{ job_id }}">
  <div class="tm-row" style="margin-bottom:.5rem">
    <strong>Training job:</strong> <span id="js-job-id">{{ job_id }}</span>
    <span id="js-status" class="tm-muted">status: pending…</span>
  </div>

  <div class="tm-progress-outer" aria-label="Training progress">
    <div class="tm-progress-inner" id="js-bar" style="width:0%"></div>
  </div>
  <div class="tm-row" style="margin-top:.5rem">
    <span id="js-percent" class="tm-muted">0%</span>
    <div>
      <a href="/generator/generate/" class="tm-btn tm-hidden" id="js-go-gen">Apri Generatore</a>
      <button type="button" class="tm-btn secondary tm-hidden" id="js-retry">Riprova</button>
    </div>
  </div>

  <div style="margin-top:1rem">
    <div class="tm-mono tm-log" id="js-log">(log…)</div>
  </div>
</div>

<script>
(function(){
  const JOB_ID     = "{{ job_id }}";
  if (!JOB_ID) return;

  const STATUS_URL = "/trainer/status/" + JOB_ID + "/";

  const elBar     = document.getElementById("js-bar");
  const elPct     = document.getElementById("js-percent");
  const elStatus  = document.getElementById("js-status");
  const elLog     = document.getElementById("js-log");
  const btnGen    = document.getElementById("js-go-gen");
  const btnRetry  = document.getElementById("js-retry");

  let stopped = false;
  function setProgress(p){
    const pct = Math.max(0, Math.min(100, parseInt(p || 0, 10)));
    elBar.style.width = pct + "%";
    elPct.textContent = pct + "%";
  }

  async function poll(){
    if (stopped) return;
    try{
      const res = await fetch(STATUS_URL, { credentials: "same-origin", cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      // aggiorna UI
      if (typeof data.progress !== "undefined") setProgress(data.progress);
      if (typeof data.log === "string") elLog.textContent = data.log || "";
      if (data.status) elStatus.textContent = "status: " + data.status;

      if (data.status === "completed"){
        setProgress(100);
        btnGen.classList.remove("tm-hidden");
        stopped = true;
        return;
      }
      if (data.status === "failed" || data.status === "error"){
        btnRetry.classList.remove("tm-hidden");
        stopped = true;
        return;
      }
    }catch(err){
      elStatus.textContent = "status: errore rete, ritento…";
    }
    setTimeout(poll, 1000);
  }

  btnRetry?.addEventListener("click", ()=>location.reload());
  poll();
})();
</script>
{% endif %}
