{% load static %}
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Addestramento LoRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>.logbox{height:220px;white-space:pre-wrap;overflow:auto;background:#111;color:#eee;padding:8px;border-radius:8px}</style>
</head>
<body class="container py-4">
  <h3 class="mb-3">Nuovo addestramento LoRA</h3>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    <div class="row g-3">
      <div class="col-md-4">{{ form.name.label_tag }} {{ form.name }}</div>
      <div class="col-md-4">{{ form.base_model.label_tag }} {{ form.base_model }}</div>
      <div class="col-md-2">{{ form.steps.label_tag }} {{ form.steps }}</div>
      <div class="col-md-1">{{ form.rank.label_tag }} {{ form.rank }}</div>
      <div class="col-md-1">{{ form.lr.label_tag }} {{ form.lr }}</div>
      <div class="col-12"><hr></div>
      <div class="col-md-6">{{ form.zip_dataset.label_tag }} {{ form.zip_dataset }}</div>
      <div class="col-md-6">
        <div>{{ form.images.label_tag }} {{ form.images }}</div>
        <div class="mt-2">{{ form.captions.label_tag }} {{ form.captions }}</div>
        <small class="text-muted">Oppure usa ZIP: immagini + opzionale <code>captions.txt</code> (righe "filename|caption").</small>
      </div>
      <div class="col-12"><button class="btn btn-primary">Avvia addestramento</button></div>
    </div>
  </form>

  {% if job_id %}
    <h5 class="mb-2">Stato job: <code id="jid">{{ job_id }}</code></h5>
    <div class="progress mb-2">
      <div id="bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:1%">1%</div>
    </div>
    <div class="logbox" id="log">In attesa di output…</div>
    <div class="mt-2" id="done" style="display:none">
      <div class="alert alert-success">
        Modello <b id="lname"></b> pronto! Lo trovi nel menù del generatore.
      </div>
    </div>
    <script>
      const job = "{{ job_id }}";
      async function poll(){
        const r = await fetch("{% url 'trainer_app:status' job_id='00000000-0000-0000-0000-000000000000' %}".replace("00000000-0000-0000-0000-000000000000", job));
        if(!r.ok) return;
        const d = await r.json();
        document.getElementById("bar").style.width = d.progress + "%";
        document.getElementById("bar").textContent = d.progress + "%";
        document.getElementById("log").textContent = d.log || "";
        if(d.status === "completed"){
          document.getElementById("lname").textContent = d.lora_name;
          document.getElementById("done").style.display = "";
        } else if(d.status === "failed"){
          document.getElementById("bar").classList.add("bg-danger");
        } else {
          setTimeout(poll, 2000);
        }
      }
      poll();
    </script>
  {% endif %}
</body>
</html>
