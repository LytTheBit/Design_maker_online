<!-- train.html -->
{% extends 'base.html' %}
{% load i18n widget_tweaks %}

{% block title %}{% trans "Addestramento LoRA" %}{% endblock %}

{% block content %}
<div class="container-xl my-5">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">{% trans "Addestramento nuovo modello LoRA" %}</h2>
  </div>

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">{{ form.name.label }}</label>
            {% render_field form.name class="form-control" placeholder="nome-modello" %}
          </div>
          <div class="col-md-4">
            <label class="form-label">{% trans "Base model" %}</label>
            {% render_field form.base_model class="form-select" %}
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ form.steps.label }}</label>
            {% render_field form.steps class="form-control" %}
          </div>
          <div class="col-md-1">
            <label class="form-label">{{ form.rank.label }}</label>
            {% render_field form.rank class="form-control" %}
          </div>
          <div class="col-md-1">
            <label class="form-label">{{ form.lr.label }}</label>
            {% render_field form.lr class="form-control" %}
          </div>
        </div>

        <hr class="my-4">

        <div class="row g-4">
          <div class="col-lg-6">
            <div class="border rounded-3 p-3 h-100">
              <div class="mb-2 fw-semibold">{% trans "Opzione A: carica ZIP del dataset" %}</div>
              {% render_field form.zip_dataset class="form-control" %}
              <small class="text-muted d-block mt-2">
                {% trans "ZIP con immagini e (opzionale) captions.txt." %}
              </small>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="border rounded-3 p-3 h-100">
              <div class="mb-2 fw-semibold">{% trans "Opzione B: immagini singole" %}</div>
              <div class="mb-2">
                <label class="form-label">{{ form.images.label|default:"Immagini" }}</label>
                {% render_field form.images class="form-control" %}
                <small class="text-muted d-block">{% trans "Puoi selezionare più file." %}</small>
              </div>
              <div>
                <label class="form-label">{{ form.captions.label|default:"Captions" }}</label>
                {% render_field form.captions class="form-control" %}
                <small class="text-muted d-block">
                  {% trans "Formato" %} <code>captions.txt</code>:
                  {% trans "una riga per file" %} <code>filename.jpg|caption</code>.
                </small>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="card-footer bg-transparent">
        <button id="submitBtn" type="submit" class="btn btn-primary">
          <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner" role="status" aria-hidden="true"></span>
          {% trans "Avvia addestramento" %}
        </button>
      </div>
    </div>
  </form>

  {% if job_id %}
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <span class="fw-semibold">{% trans "Stato job" %}:</span>
        <code id="jid">{{ job_id }}</code>
      </div>
      <small class="text-muted" id="statusLabel">running…</small>
    </div>
    <div class="card-body">
      <div class="progress mb-3" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div id="bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 1%">1%</div>
      </div>

      <pre class="logbox mb-0" id="log">In attesa di output…</pre>

      <div class="alert alert-success mt-3 d-none" id="done">
        {% trans "Modello" %} <b id="lname"></b> {% trans "pronto! Lo trovi nel menù del generatore." %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<style>
  /* solo per questa pagina */
  .logbox{
    height: 320px;
    background: #0f172a;
    color: #e2e8f0;
    border-radius: .5rem;
    padding: 12px;
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: .9rem;
  }
</style>

{% if job_id %}
<script>
  // spinner su submit
  const submitBtn = document.getElementById('submitBtn');
  const spinner = document.getElementById('spinner');
  if (submitBtn) {
    submitBtn.addEventListener('click', () => {
      if (spinner) spinner.classList.remove('d-none');
      submitBtn.setAttribute('disabled', 'disabled');
    });
  }

  // polling stato job + autoscroll log
  const job = "{{ job_id }}";
  function autoscroll(el){ el.scrollTop = el.scrollHeight; }
  async function poll(){
    const url = "{% url 'trainer_app:status' job_id='00000000-0000-0000-0000-000000000000' %}".replace("00000000-0000-0000-0000-000000000000", job);
    try{
      const r = await fetch(url);
      if(!r.ok){ setTimeout(poll, 2000); return; }
      const d = await r.json();
      const bar = document.getElementById("bar");
      bar.style.width = d.progress + "%";
      bar.textContent = d.progress + "%";
      document.getElementById("log").textContent = d.log || "";
      autoscroll(document.getElementById("log"));
      document.getElementById("statusLabel").textContent = d.status;

      if(d.status === "completed"){
        document.getElementById("lname").textContent = d.lora_name;
        document.getElementById("done").classList.remove("d-none");
        bar.classList.remove("progress-bar-animated");
      } else if(d.status === "failed"){
        bar.classList.add("bg-danger");
        bar.classList.remove("progress-bar-animated");
      } else {
        setTimeout(poll, 2000);
      }
    }catch(e){ setTimeout(poll, 3000); }
  }
  poll();
</script>
{% endif %}
{% endblock %}
